---
- hosts: kubernetes_master_nodes
  become: true
  vars_files:
  - env_variables 
  tasks:

  - name: Set up KUBELET_EXTRA_ARGS
    file:
     path: /etc/default/kubelet
     state: touch

  - name: Add content to extra args
    blockinfile:
     path: /etc/default/kubelet
     block: | 
         KUBELET_EXTRA_ARGS=--cgroup-driver=systemd --container-runtime=remote --container-runtime-endpoint="unix:///var/run/crio/crio.sock"

  - name: Reload Daemons 
    systemd:
      daemon_reload: yes

  - name: Initializing Kubernetes cluster
    shell: kubeadm init --apiserver-advertise-address {{ad_addr}} --pod-network-cidr={{cidr_v}} > kubeadm_logs
    register: output
    become: true

  - name: Creating .kube directory
    file: 
      path: /home/lab/.kube
      state: directory

  - name: Copying kubeconfig files 
    copy:
      src: /etc/kubernetes/admin.conf
      dest: /home/lab/.kube/config
      owner: lab
      group: lab
      remote_src: yes
    become: yes
 
  - name: Installing Network Add-on
    command: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
    become_user: lab


